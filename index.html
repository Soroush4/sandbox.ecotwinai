<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Digital Twin Sandbox</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app">
        <!-- Menu Bar -->
        <nav class="menu-bar">
            <div class="menu-item">
                <span class="menu-label">File</span>
                <div class="menu-dropdown">
                    <div class="menu-option has-submenu">
                        <span>New Scene</span>
                        <span class="submenu-arrow">â–¶</span>
                        <div class="submenu">
                            <div class="menu-option" data-action="empty-scene">Empty Scene</div>
                            <div class="menu-option" data-action="default-scene">Default Scene</div>
                        </div>
                    </div>
                    <div class="menu-option" data-action="save-scene">Save Scene</div>
                    <div class="menu-option" data-action="load-scene">Load Scene</div>
                    <div class="menu-separator"></div>
                    <div class="menu-option" data-action="export-stl">Export STL</div>
                    <div class="menu-option" data-action="import-stl">Import STL</div>
                </div>
            </div>
            <div class="menu-item">
                <span class="menu-label">Edit</span>
                <div class="menu-dropdown">
                    <div class="menu-option" data-action="undo">Undo</div>
                    <div class="menu-option" data-action="redo">Redo</div>
                    <div class="menu-separator"></div>
                    <div class="menu-option" data-action="select-all">
                        <span class="menu-text">Select All</span>
                        <span class="shortcut">Shift+A</span>
                    </div>
                    <div class="menu-option" data-action="clear-selection">
                        <span class="menu-text">Clear Selection</span>
                        <span class="shortcut">Shift+D</span>
                    </div>
                    <div class="menu-separator"></div>
                    <div class="menu-option" data-action="delete-selected">Delete Selected</div>
                </div>
            </div>
            <div class="menu-item">
                <span class="menu-label">Settings</span>
                <div class="menu-dropdown">
                    <div class="menu-option" data-action="preferences">Preferences</div>
                    <div class="menu-option" data-action="about">About</div>
                </div>
            </div>
        </nav>

        <!-- Drawing Tools Panel -->
        <div id="drawingPanel" class="drawing-panel">
            <div class="panel-header">
                <h3>Drawing</h3>
            </div>
            <div class="drawing-tools">
                <div class="tool-item" data-tool="rectangle" title="Rectangle">
                    <img src="icons/rectangle.svg" alt="Rectangle" class="tool-icon">
                </div>
                <div class="tool-item" data-tool="circle" title="Circle">
                    <img src="icons/circle.svg" alt="Circle" class="tool-icon">
                </div>
                <div class="tool-item" data-tool="polygon" title="Polygon">
                    <img src="icons/polygon.svg" alt="Polygon" class="tool-icon">
                </div>
                <div class="tool-item" data-tool="tree" title="Tree" id="treeTool">
                    <img src="icons/tree.svg" alt="Tree" class="tool-icon">
                </div>
            </div>
            <div class="tree-submenu" id="treeSubmenu" style="display: none;">
                <div class="tree-options">
                    <div class="tree-option" data-tree-type="1" title="Tree Type 1">
                        <img src="icons/tree1.svg" alt="Tree 1" class="tree-icon">
                    </div>
                    <div class="tree-option" data-tree-type="2" title="Tree Type 2">
                        <img src="icons/tree2.svg" alt="Tree 2" class="tree-icon">
                    </div>
                    <div class="tree-option" data-tree-type="3" title="Tree Type 3">
                        <img src="icons/tree3.svg" alt="Tree 3" class="tree-icon">
                    </div>
                    <div class="tree-option" data-tree-type="4" title="Tree Type 4">
                        <img src="icons/tree4.svg" alt="Tree 4" class="tree-icon">
                    </div>
                </div>
                <div class="tree-height-controls">
                    <div class="height-control-group">
                        <label for="minHeight">Min:</label>
                        <input type="number" id="minHeight" min="0.1" max="50" step="0.1" value="5">
                    </div>
                    <div class="height-control-group">
                        <label for="maxHeight">Max:</label>
                        <input type="number" id="maxHeight" min="0.1" max="50" step="0.1" value="10">
                    </div>
                    <div class="height-control-group">
                        <label for="treeDistance">Distance:</label>
                        <input type="number" id="treeDistance" min="0.5" max="20" step="0.1" value="2">
                    </div>
                </div>
            </div>
        </div>

        <!-- Transform Tools Panel -->
        <div id="transformPanel" class="transform-panel">
            <div class="transform-tools">
                <div class="tool-item active" data-tool="select" title="Select">
                    <img class="tool-icon" src="icons/select.svg" alt="Select" width="20" height="20">
                </div>
                <div class="tool-item" data-tool="move" title="Move">
                    <img class="tool-icon" src="icons/move.svg" alt="Move" width="20" height="20">
                </div>
                <div class="tool-item" data-tool="rotate" title="Rotate">
                    <img class="tool-icon" src="icons/rotate.svg" alt="Rotate" width="20" height="20">
                </div>
                <div class="tool-item" data-tool="scale" title="Scale">
                    <img class="tool-icon" src="icons/scale.svg" alt="Scale" width="20" height="20">
                </div>
                <div class="tool-item" data-tool="coordinate-toggle" title="Toggle Local/Global Coordinates" id="coordinateToggle">
                    <img class="tool-icon" src="icons/global.svg" alt="Global" width="20" height="20" id="coordinateIcon">
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar (Hidden - moved to preferences) -->
            <aside class="sidebar" style="display: none;">
                <div class="sidebar-section">
                    <h3>Scene Controls</h3>
                    <div class="control-group">
                        <label for="gridToggle">Show Grid</label>
                        <button id="gridToggle" class="toggle-btn active">
                            <svg class="icon" viewBox="0 0 24 24">
                                <use href="icons/grid.svg#icon"></use>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Building Settings</h3>
                    <div class="control-group">
                        <label for="buildingCount">Building Count</label>
                        <input type="range" id="buildingCount" min="1" max="20" value="10">
                        <span id="buildingCountValue">10</span>
                    </div>
                    <div class="control-group">
                        <label for="minHeight">Min Height (m)</label>
                        <input type="range" id="minHeight" min="2" max="10" value="4">
                        <span id="minHeightValue">4</span>
                    </div>
                    <div class="control-group">
                        <label for="maxHeight">Max Height (m)</label>
                        <input type="range" id="maxHeight" min="10" max="30" value="20">
                        <span id="maxHeightValue">20</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Camera Controls</h3>
                    <div class="control-group">
                        <button id="resetCamera" class="btn btn-small">
                            <svg class="icon" viewBox="0 0 24 24">
                                <use href="icons/camera.svg#icon"></use>
                            </svg>
                            Reset Camera
                        </button>
                    </div>
                </div>
            </aside>

            <!-- 3D Canvas -->
            <div class="canvas-container">
                <canvas id="renderCanvas"></canvas>
                <div class="canvas-overlay">
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Preferences Overlay -->
    <div id="preferencesOverlay" class="preferences-overlay"></div>

    <!-- Preferences Window -->
    <div id="preferencesWindow" class="preferences-window">
        <div class="preferences-header">
            <h3>Preferences</h3>
            <button id="closePreferences" class="close-btn">&times;</button>
        </div>
        <div class="preferences-content">
            <!-- Scene Controls -->
            <div class="preferences-section">
                <h4>Scene Controls</h4>
                <div class="control-group">
                    <label for="gridTogglePref">Show Grid</label>
                    <button id="gridTogglePref" class="toggle-btn active">
                    </button>
                </div>
                <div class="control-group">
                    <label for="shadowTogglePref">Object Shadows</label>
                    <button id="shadowTogglePref" class="toggle-btn active">
                    </button>
                </div>
                <div class="control-group">
                    <label for="hardShadowTogglePref">Hard Shadows (Performance)</label>
                    <button id="hardShadowTogglePref" class="toggle-btn active">
                    </button>
                </div>
                <div class="control-group">
                    <label for="lightIntensityPref">Light Intensity</label>
                    <input type="range" id="lightIntensityPref" min="0.5" max="3.0" step="0.1" value="1.6">
                    <span id="lightIntensityValuePref">1.6</span>
                </div>
                <div class="control-group">
                    <label for="shadowDarknessPref">Shadow Darkness</label>
                    <input type="range" id="shadowDarknessPref" min="0.1" max="0.8" step="0.05" value="0.4">
                    <span id="shadowDarknessValuePref">0.4</span>
                </div>
                <div class="control-group">
                    <label for="shadowBiasPref">Shadow Bias</label>
                    <input type="range" id="shadowBiasPref" min="0.00001" max="0.001" step="0.00001" value="0.00043">
                    <span id="shadowBiasValuePref">0.00043</span>
                </div>
                <div class="control-group">
                    <label for="shadowNormalBiasPref">Shadow Normal Bias</label>
                    <input type="range" id="shadowNormalBiasPref" min="0.01" max="0.2" step="0.01" value="0.01">
                    <span id="shadowNormalBiasValuePref">0.01</span>
                </div>
                <div class="control-group">
                    <label for="shadowDepthScalePref">Shadow Depth Scale</label>
                    <input type="range" id="shadowDepthScalePref" min="10" max="200" step="5" value="85">
                    <span id="shadowDepthScaleValuePref">85</span>
                </div>
                <div class="control-group">
                    <label for="shadowOrthoScalePref">Shadow Ortho Scale</label>
                    <input type="range" id="shadowOrthoScalePref" min="50" max="500" step="10" value="260">
                    <span id="shadowOrthoScaleValuePref">260</span>
                </div>
                <div class="control-group">
                    <label for="shadowFrustumSizePref">Shadow Frustum Size</label>
                    <input type="range" id="shadowFrustumSizePref" min="100" max="600" step="10" value="350">
                    <span id="shadowFrustumSizeValuePref">350</span>
                </div>
            </div>

            <!-- Building Settings -->
            <div class="preferences-section">
                <h4>Building Settings</h4>
                <div class="control-group">
                    <label for="buildingCountPref">Building Count</label>
                    <input type="range" id="buildingCountPref" min="1" max="20" value="10">
                    <span id="buildingCountValuePref">10</span>
                </div>
                <div class="control-group">
                    <label for="minHeightPref">Min Height (m)</label>
                    <input type="range" id="minHeightPref" min="2" max="10" value="4">
                    <span id="minHeightValuePref">4</span>
                </div>
                <div class="control-group">
                    <label for="maxHeightPref">Max Height (m)</label>
                    <input type="range" id="maxHeightPref" min="10" max="30" value="20">
                    <span id="maxHeightValuePref">20</span>
                </div>
            </div>

            <!-- Camera Controls -->
            <div class="preferences-section">
                <h4>Camera Controls</h4>
                <div class="control-group">
                    <button id="resetCameraPref" class="btn btn-small">
                        <svg class="icon" viewBox="0 0 24 24">
                            <use href="icons/camera.svg#icon"></use>
                        </svg>
                        Reset Camera
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="preferences-section">
                <h4>Statistics</h4>
                <div class="control-group">
                    <label for="statisticsTogglePref">Show Statistics</label>
                    <button id="statisticsTogglePref" class="btn btn-toggle">
                        <svg class="icon" viewBox="0 0 24 24">
                            <use href="icons/chart.svg#icon"></use>
                        </svg>
                        <span class="toggle-text">Show Statistics</span>
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="preferences-section">
                <h4>Actions</h4>
                <div class="control-group">
                    <button id="generateBuildingsPref" class="btn btn-primary">
                        <svg class="icon" viewBox="0 0 24 24">
                            <use href="icons/buildings.svg#icon"></use>
                        </svg>
                        Generate Buildings
                    </button>
                </div>
                <div class="control-group">
                    <button id="resetScenePref" class="btn btn-secondary">
                        <svg class="icon" viewBox="0 0 24 24">
                            <use href="icons/reset.svg#icon"></use>
                        </svg>
                        Reset Scene
                    </button>
                </div>
                <div class="control-group">
                    <button id="saveLightingSettingsPref" class="btn btn-primary">
                        <svg class="icon" viewBox="0 0 24 24">
                            <use href="icons/save.svg#icon"></use>
                        </svg>
                        Save Lighting Settings
                    </button>
                </div>
                <div class="control-group">
                    <button id="createTestCircle" class="btn btn-primary" style="background-color: #ff6b6b;">
                        <svg class="icon" viewBox="0 0 24 24">
                            <use href="icons/circle.svg#icon"></use>
                        </svg>
                        Create Test Circle (R=5, H=8)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compass -->
    <div id="compass" class="compass">
        <div class="compass-inner">
            <div class="compass-needle" id="compassNeedle"></div>
            <div class="compass-labels">
                <div class="compass-label compass-north">N</div>
                <div class="compass-label compass-east">E</div>
                <div class="compass-label compass-south">S</div>
                <div class="compass-label compass-west">W</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/libs/babylon.js"></script>
    <script src="js/libs/babylonjs.materials.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://unpkg.com/earcut@2.2.4/dist/earcut.min.js"></script>
    <script src="js/modules/SceneManager.js?v=2"></script>
    <script src="js/modules/BuildingGenerator.js"></script>
    <script src="js/modules/LightingManager.js"></script>
    <script src="js/modules/CameraController.js?v=5"></script>
    <script src="js/modules/GridManager.js"></script>
    <script src="js/modules/SelectionManager.js"></script>
    <script src="js/modules/MoveManager.js"></script>
    <script src="js/modules/RotateManager.js"></script>
    <script src="js/modules/ScaleManager.js"></script>
    <script src="js/modules/Shape2DManager.js"></script>
    <script src="js/modules/TreeManager.js"></script>
    <script src="js/modules/PolygonManager.js"></script>
    <script src="js/modules/RectangleManager.js"></script>
    <script src="js/modules/CircleManager.js"></script>
    <script src="js/modules/FPSMonitor.js"></script>
    <script src="js/modules/UIManager.js"></script>
    <!-- Properties Popup -->
    <div id="propertiesPopup" class="properties-popup">
        <div class="properties-header">
            <h3>Shape Properties</h3>
            <button class="close-btn" id="closeProperties">&times;</button>
        </div>
        <div class="properties-content">
            <div class="property-group">
                <label>Name:</label>
                <input type="text" id="shapeName" readonly>
            </div>
            <div class="property-group">
                <label>Type:</label>
                <select id="shapeType">
                    <option value="ground">Ground</option>
                    <option value="waterway">Waterway</option>
                    <option value="highway">Highway</option>
                    <option value="green">Green</option>
                    <option value="building">Building</option>
                </select>
            </div>
            <div class="property-group">
                <label>Color:</label>
                <input type="color" id="shapeColor">
            </div>
            <div class="property-group">
                <label>Length:</label>
                <input type="number" id="shapeLength" step="0.1" min="0.1" value="1.0">
            </div>
            <div class="property-group">
                <label>Width:</label>
                <input type="number" id="shapeWidth" step="0.1" min="0.1" value="1.0">
            </div>
            <div class="property-group" id="heightGroup" style="display: flex;">
                <label>Height:</label>
                <input type="number" id="shapeHeight" step="0.1" min="0.1" value="0.1">
            </div>
            <div class="property-group" id="radiusGroup" style="display: none;">
                <label>Radius:</label>
                <input type="number" id="shapeRadius" step="0.1" min="0">
            </div>
        </div>
        <div class="properties-footer">
            <button class="btn btn-primary" id="saveProperties">Save</button>
            <button class="btn btn-secondary" id="cancelProperties">Cancel</button>
        </div>
    </div>

    <!-- Circle Properties Popup -->
    <div id="circlePropertiesPopup" class="properties-popup">
        <div class="properties-header">
            <h3>Circle Properties</h3>
            <button class="close-btn" id="closeCircleProperties">&times;</button>
        </div>
        <div class="properties-content">
            <div class="property-group">
                <label>Name:</label>
                <input type="text" id="circleName" readonly>
            </div>
            <div class="property-group">
                <label>Type:</label>
                <select id="circleType">
                    <option value="ground">Ground</option>
                    <option value="waterway">Waterway</option>
                    <option value="highway">Highway</option>
                    <option value="green">Green</option>
                    <option value="building">Building</option>
                </select>
            </div>
            <div class="property-group">
                <label>Color:</label>
                <input type="color" id="circleColor" value="#663300">
            </div>
            <div class="property-group" id="circleDiameterGroup">
                <label>Diameter:</label>
                <input type="number" id="circleDiameter" step="0.1" min="0.1" value="1.0">
            </div>
            <div class="property-group" id="circleHeightGroup">
                <label>Height:</label>
                <input type="number" id="circleHeight" step="0.1" min="0.1" value="0.1">
            </div>
        </div>
        <div class="properties-footer">
            <button class="btn btn-primary" id="saveCircleProperties">Save</button>
            <button class="btn btn-secondary" id="cancelCircleProperties">Cancel</button>
        </div>
    </div>

    <!-- Polygon Properties Popup -->
    <div id="polygonPropertiesPopup" class="properties-popup">
        <div class="properties-header">
            <h3>Polygon Properties</h3>
            <button class="close-btn" id="closePolygonProperties">&times;</button>
        </div>
        <div class="properties-content">
            <div class="property-group">
                <label>Name:</label>
                <input type="text" id="polygonName" readonly>
            </div>
            <div class="property-group">
                <label>Type:</label>
                <select id="polygonType">
                    <option value="land">Land</option>
                    <option value="water">Water</option>
                    <option value="road">Road</option>
                    <option value="green">Green Space</option>
                    <option value="building">Building Area</option>
                    <option value="parking">Parking</option>
                    <option value="garden">Garden</option>
                </select>
            </div>
            <div class="property-group">
                <label>Color:</label>
                <input type="color" id="polygonColor" value="#32CD32">
            </div>
            <div class="property-group">
                <label>Height:</label>
                <input type="number" id="polygonHeight" step="0.01" min="0.01" max="10" value="0.01">
            </div>
            <div class="property-group">
                <label>Vertices:</label>
                <input type="number" id="polygonVertices" readonly>
            </div>
            <div class="property-group">
                <label>Area:</label>
                <input type="text" id="polygonArea" readonly>
            </div>
            <div class="property-group">
                <label>Perimeter:</label>
                <input type="text" id="polygonPerimeter" readonly>
            </div>
            <div class="property-group">
                <label>Material:</label>
                <select id="polygonMaterial">
                    <option value="standard">Standard</option>
                    <option value="grass">Grass</option>
                    <option value="concrete">Concrete</option>
                    <option value="asphalt">Asphalt</option>
                    <option value="water">Water</option>
                    <option value="sand">Sand</option>
                </select>
            </div>
            <div class="property-group">
                <label>Opacity:</label>
                <input type="range" id="polygonOpacity" min="0.1" max="1.0" step="0.1" value="1.0">
                <span id="polygonOpacityValue">100%</span>
            </div>
        </div>
        <div class="properties-footer">
            <button class="btn btn-primary" id="savePolygonProperties">Save</button>
            <button class="btn btn-secondary" id="cancelPolygonProperties">Cancel</button>
        </div>
    </div>

    <script src="js/app.js?v=2"></script>
</body>
</html>
